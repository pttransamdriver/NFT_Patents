import path from "node:path";
import { HardhatError } from "@nomicfoundation/hardhat-errors";
import { batches, IgnitionModuleSerializer, } from "@nomicfoundation/ignition-core";
import { loadModule } from "../utils/load-module.js";
import { open } from "../utils/open.js";
import { writeVisualization } from "../visualization/write-visualization.js";
const visualizeTask = async ({ noOpen, modulePath }, hre) => {
    await hre.tasks.getTask("compile").run({ quiet: true });
    const userModule = await loadModule(hre.config.paths.ignition, modulePath);
    if (userModule === undefined) {
        throw new HardhatError(HardhatError.ERRORS.IGNITION.INTERNAL.NO_MODULES_FOUND);
    }
    try {
        const serializedIgnitionModule = IgnitionModuleSerializer.serialize(userModule);
        const batchInfo = batches(userModule);
        await writeVisualization({ module: serializedIgnitionModule, batches: batchInfo }, {
            cacheDir: hre.config.paths.cache,
        });
    }
    catch (e) {
        if (e instanceof Error) {
            throw new HardhatError(HardhatError.ERRORS.IGNITION.INTERNAL.INTERNAL_ERROR, e);
        }
        throw e;
    }
    if (!noOpen) {
        const indexFile = path.join(hre.config.paths.cache, "visualization", "index.html");
        console.log(`Deployment visualization written to ${indexFile}`);
        open(indexFile);
    }
};
export default visualizeTask;
//# sourceMappingURL=visualize.js.map